---
title: "Report Group 2"
author: "Pom"
date: "2024-02-28"
output:
  pdf_document:
    toc: yes
    number_sections: yes
  word_document:
    toc: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,comment=NA,attr.source='.numberLines')

rm(list=ls())
library(readr)
library(RSQLite)
library(dplyr)
library(ggplot2)
library(lubridate)
library(treemapify)
```

# Task 1.2: SQL Database Schema Creation
```{r connect}
# set up the connection
my_db <- RSQLite::dbConnect(RSQLite::SQLite(),"../database/ecommerce.db")
```

## CREATE tables 
````{bash, eval=FALSE}
# link to SQL file
sqlite3 "../database/ecommerce.db" < "../main/ecommerce.sql"
```

# For Initial load
## Validation and Load files in an sqlite database
```{r}
# Get only Initial file
all_files <- setdiff(list.files("../data_upload/"), list.files("../data_upload/", pattern = "_"))
# Order the files to load to database, to avoid error from foreign key
custom_order <- list("customers.csv","sellers.csv","categories.csv","products.csv","shippers.csv","orders.csv","advertisements.csv")
all_files <- all_files[order(match(all_files, custom_order))]

for (variable in all_files) {
  this_filepath <- paste0("../data_upload/",variable)
  this_file_contents <- readr::read_csv(this_filepath)

  table_name <- gsub(".csv","",variable)
  
  # Get the primary key column names from the database
  query <- paste("SELECT name FROM pragma_table_info('",table_name,"') WHERE pk = 1;",sep="")
  primary_key_columns <- dbGetQuery(my_db, query)
  
  # Get Foreign Key
  query <- paste("PRAGMA foreign_key_list('",table_name,"');",sep="")
  foreign_key_columns <- dbGetQuery(my_db, query)
  
  # Perform Validation
  source("Validation.R")
  
  # convert column date format
  if (table_name == 'orders') {
    this_file_contents['order_date'] <- lapply(this_file_contents['order_date'], as.character)
  }
  
  if (nrow(this_file_contents)>0 ){
      for (i in 1:nrow(this_file_contents)) {
        row <- this_file_contents[i, ]
        
        # Extract primary key values from the row
        primary_key_values <- paste(names(row)[names(row) %in% primary_key_columns], row[names(row) %in% primary_key_columns], sep = "=", collapse = " AND ")
        
        # Find if the primary key exists
        query <- paste("SELECT * FROM", table_name, paste("WHERE", primary_key_values))
        existing_row <- dbGetQuery(my_db, query)
        
        if (nrow(existing_row) == 0) {
          # Row is unique, append to the table
          #print(paste("Append:",primary_key_values))
          dbWriteTable(my_db, table_name, row, append = TRUE)
        } else {
          # Row already exists, update the existing row
          #print(paste("Update:",primary_key_values))
          update_query <- paste("UPDATE", table_name, paste("SET", paste(names(row), "=", paste0("'", row, "'"), collapse = ", "), "WHERE", primary_key_values))
          dbExecute(my_db, update_query)
        }
      }
    }
    else {
      print("Nothing to update in database since all rows are not pass the validations")
    }
  
  #RSQLite::dbWriteTable(my_db,table_name,this_file_contents,append=TRUE)
}

```

```{sql connection=my_db}
select *
from customers
```

# Reading data from database after validation

```{r}

# Define SQL queries for each table
sql_queries <- list(
  orders = "SELECT * FROM orders",
  customers = "SELECT * FROM customers",
  categories = "SELECT * FROM categories",
  advertisements = "SELECT * FROM advertisements",
  shippers = "SELECT * FROM shippers",
  products = "SELECT * FROM products",
  sellers = "SELECT * FROM sellers"
)


# Read data from each table using SQL queries

orders <- dbGetQuery(my_db, 
                     sql_queries$orders)
customers <- dbGetQuery(my_db, 
                        sql_queries$customers)
categories <- dbGetQuery(my_db, 
                         sql_queries$categories)
advertisements <- dbGetQuery(my_db, 
                             sql_queries$advertisements)
shippers <- dbGetQuery(my_db, 
                       sql_queries$shippers)
products <- dbGetQuery(my_db, 
                       sql_queries$products)
sellers <- dbGetQuery(my_db, 
                      sql_queries$sellers)
```

# Data Analysis 

```{sql connection=my_db}
-- Average discount percentage applied to orders
SELECT AVG(discount) AS average_discount
FROM orders;
```

```{sql connection=my_db}
-- Number of Categories
SELECT COUNT(*) AS total_categories
FROM categories;
```

# Query 1:  Number of Products in Each Category

```{r}
## Categories with number of products in each category

category_products <- dbGetQuery(my_db, "SELECT c.name AS category_name, COUNT(p.id) AS num_products
                              FROM products AS p
                              INNER JOIN categories AS c ON p.category_id = c.id
                              GROUP BY p.category_id, c.name
                              ORDER BY num_products DESC
                              LIMIT 10")

category_products %>%
ggplot(aes(x = reorder(category_name, -num_products), y = num_products)) +
  geom_bar(stat = "identity", fill = "maroon", color = "black") +
  labs(title = "Number of Products in Each Category",
       x = "Category Name",
       y = "Number of Products") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1),
        axis.title.y = element_text(size = 12),
        axis.title.x = element_text(size = 12),
        plot.title = element_text(size = 14, hjust = 0.5),
        panel.border = element_rect(color = "black", fill = NA, size = 1),
        plot.margin = margin(t = 0.5, r = 0.5, b = 1, l = 1, unit = "cm")) +  # Specify margins
  geom_text(aes(label = num_products), vjust = -0.3, size = 3, color = "black")  # Add labels for each bar


# Saving the image for the plot
this_filename_date <- as.character(Sys.Date())
this_filename_time <- as.character(format(Sys.time(), format = "%H_%M"))

ggsave(paste0("Visualisations/number_of_products_in_each_category",
              this_filename_date,"_",
              this_filename_time,".png"))


```

# Query 2: Monthly Sales Analysis

```{r}

daily_sales <- dbGetQuery(my_db, "
  SELECT order_date,
  price * quantity * (1 - (discount / 100)) AS revenue
  FROM orders
  JOIN products ON orders.product_id = products.id
")

# Convert order_date to date format
daily_sales$order_date <- as.Date(daily_sales$order_date, format = "%Y-%m-%d")

# Aggregate by month
monthly_sales <- daily_sales %>%
  mutate(year_month = floor_date(order_date, "month")) %>%
  group_by(year_month) %>%
  summarise(revenue = sum(revenue))

# Plot monthly sales trend with advanced visualization
ggplot(monthly_sales, aes(x = year_month, y = revenue)) +
  geom_line(color = "blue", size = 1.5) +
  geom_point(color = "red", size = 3) +
  geom_smooth(method = "lm", se = FALSE, color = "darkgreen", linetype = "dashed") +
  labs(title = "Monthly Sales Trend", x = "Date", y = "Revenue") +
  theme_bw() + 
  theme(plot.title = element_text(size = 20, face = "bold"),
        axis.title = element_text(size = 14),
        axis.text = element_text(size = 12),
        legend.position = "none",
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1)) + # Rotate x-axis labels vertically
  scale_x_date(date_breaks = "1 month", date_labels = "%b %Y") +
  scale_y_continuous(labels = scales::dollar_format(prefix = "$"))

# Saving the image file for the plot
this_filename_date <- as.character(Sys.Date())
this_filename_time <- as.character(format(Sys.time(), format = "%H_%M"))

ggsave(paste0("Visualisations/monthly_sales_analysis",
              this_filename_date,"_",
              this_filename_time,".png"))



```

# Query 3: Top 10 Selling Products by Quantity Sold

```{r}
top_products <- dbGetQuery(my_db,
  "SELECT p.name AS product_name, SUM(o.quantity) AS total_sold
  FROM products AS p
  INNER JOIN orders AS o ON p.id = o.product_id
  GROUP BY p.name
  ORDER BY total_sold DESC
  LIMIT 10")


top_products %>%
  ggplot(aes(x = reorder(product_name, total_sold), y = total_sold, fill = product_name)) +
  geom_bar(stat = "identity", color = "black") +
  scale_fill_brewer(palette = "Paired") +  # Using a built-in palette
  labs(title = "Top 10 Selling Products",
       x = "Product",
       y = "Total Quantity Sold") +
  theme_minimal(base_size = 14) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12, color = "black"),
        axis.text.y = element_text(size = 12, color = "black"),
        axis.title = element_text(size = 16, color = "black", face = "bold"),
        plot.title = element_text(size = 20, color = "black", face = "bold"),
        legend.position = "none") +
  scale_y_continuous(labels = scales::comma_format()) +
  coord_flip() +  # Flip the coordinates to make horizontal bars
  geom_text(aes(label = total_sold), vjust = -0.3, size = 4, color = "black", fontface = "bold")

# Saving the image for the plot
this_filename_date <- as.character(Sys.Date())
this_filename_time <- as.character(format(Sys.time(), format = "%H_%M"))

ggsave(paste0("Visualisations/Top 10 Selling Products by Quantity Sold",
              this_filename_date,"_",
              this_filename_time,".png"))


```


# Query 4: Top 10 Sellers by the Total Revenue

```{r}

top_sellers <- dbGetQuery(my_db,
                "SELECT s.name AS seller_name, ROUND(SUM(p.price * o.quantity * (1 - (o.discount / 100)))) AS total_revenue
                FROM sellers AS s
                INNER JOIN products AS p ON s.id = p.seller_id
                INNER JOIN orders AS o ON p.id = o.product_id
                GROUP BY s.name
                ORDER BY total_revenue DESC
                LIMIT 10")

top_sellers %>%
  ggplot(aes(x = total_revenue, y = reorder(seller_name, total_revenue), fill = seller_name)) +
  geom_bar(stat = "identity") +
  labs(title = "Top 10 Sellers by Total Revenue",
       subtitle = "Total Revenue for the Top 10 Sellers",
       x = "Total Revenue (in USD)",
       y = "Sellers", 
       fill = "Seller Name") +  
  scale_fill_brewer(palette = "Paired") +
  theme_bw() +
  theme(plot.title = element_text(size = 20, face = "bold"),
        plot.subtitle = element_text(size = 14),
        axis.title = element_text(size = 14),
        axis.text.y = element_text(size = 12),
        axis.text.x = element_text(size = 10, angle = 45, hjust = 1, vjust = 1),  
        panel.grid = element_blank()) +
  geom_text(aes(label = total_revenue), # Remove scales::dollar()
            position = position_stack(vjust = 1.1), 
            hjust = 0.6, color = "black", size = 3) +  
  coord_flip()

# Saving the image for the plot
this_filename_date <- as.character(Sys.Date())
this_filename_time <- as.character(format(Sys.time(), format = "%H_%M"))

ggsave(paste0("Visualisations/Top_10_Sellers_by_total_revenue",
              this_filename_date,"_",
              this_filename_time,".png"))



```

# Query 5: Top 10 Customers by the Amount Spent

```{r}
top_customers <- dbGetQuery(my_db,
  "SELECT c.id AS customer_id, CONCAT(c.first_name, ' ', c.last_name) AS customer_name, 
       ROUND(SUM(p.price * o.quantity * (1 - (o.discount / 100)))) AS total_spent
        FROM customers AS c
        INNER JOIN orders AS o ON c.id = o.customer_id
        INNER JOIN products AS p ON o.product_id = p.id
        GROUP BY c.id, customer_name
        ORDER BY total_spent DESC
        LIMIT 10"
)

# Prepare data for stacked bar chart

top_customers %>%
arrange(desc(total_spent)) %>%
ggplot(aes(x = reorder(customer_name, total_spent), y = total_spent, fill = customer_name)) +
  geom_bar(stat = "identity") +
  labs(title = "Top Customers' Share of Total Spent",
       x = "Customer",
       y = "Total Spent") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position = "none") +
  scale_fill_brewer(palette = "Set3") +
  geom_text(aes(label = total_spent), size = 4, color = "black") +
  coord_flip()

# Saving the image for the plot
this_filename_date <- as.character(Sys.Date())
this_filename_time <- as.character(format(Sys.time(), format = "%H_%M"))

ggsave(paste0("Visualisations/Top_10_customers_by_amount_spent",
              this_filename_date,"_",
              this_filename_time,".png"))



```

# Query 6: Top Rating Products (Need to re-check)

```{r}

top_rating_products <- dbGetQuery(my_db, "
SELECT categories.name AS category, AVG(orders.rating_review) AS avg_rating, SUM(orders.quantity) AS total_sales
FROM products
INNER JOIN orders ON products.id = orders.product_id
INNER JOIN categories ON products.category_id = categories.id
WHERE orders.rating_review IS NOT NULL
GROUP BY categories.name"
)

# Create the visualization
ggplot(top_rating_products, aes(x = total_sales, y = avg_rating, size = total_sales, fill = category)) +
  geom_point(shape = 21, color = "black", alpha = 0.6) + # Adding transparency for better visibility
  scale_size_continuous(range = c(5, 20)) + # Adjusting size range for better differentiation
  labs(title = "Product Ratings vs Total Sales by Category",
       x = "Total Sales",
       y = "Average Rating",
       size = "Total Sales",
       fill = "Category") +
  theme_minimal() +
  theme(
    plot.title = element_text(size = 16, face = "bold", hjust = 0.5), # Adjusting title size and alignment
    axis.title = element_text(size = 12), # Adjusting axis label size
    axis.text = element_text(size = 10), # Adjusting axis text size
    legend.title = element_text(size = 12), # Adjusting legend title size
    legend.text = element_text(size = 10), # Adjusting legend text size
    legend.position = "bottom", # Positioning the legend at the bottom
    legend.box = "horizontal" # Setting legend layout to horizontal
  ) +
  geom_text(aes(label = category), vjust = -1, hjust = 0, size = 3) + # Adding category labels
  annotate("text", x = 500, y = 4.5, label = "Bubble size represents total sales", 
           size = 3, color = "black", fontface = "italic", hjust = 0) # Adding annotation for bubble size explanation

# Saving the image for the plot
this_filename_date <- as.character(Sys.Date())
this_filename_time <- as.character(format(Sys.time(), format = "%H_%M"))

ggsave(paste0("Visualisations/Product_ratings_vs_total_sales_by_category",
              this_filename_date,"_",
              this_filename_time,".png"))


```

## Query 7: Sales by Categories

```{r}
sales_by_category <- dbGetQuery(my_db, "
  SELECT c.name AS category_name, SUM(p.price * o.quantity * (1 - (o.discount / 100))) AS total_sales
  FROM categories AS c
  LEFT JOIN products AS p ON c.id = p.category_id
  LEFT JOIN orders AS o ON p.id = o.product_id
  GROUP BY c.name
")

sales_by_category %>%
  ggplot(aes(area = total_sales, fill = category_name, label = paste0(category_name, "\n", scales::dollar(total_sales)))) +
  geom_treemap() +
  geom_treemap_text(fontface = "bold", place = "centre", grow = TRUE, reflow = TRUE, color = "lightgrey") + # Change text color to light grey
  scale_fill_viridis_d() +  # You can use any other color palette as per your preference
  labs(title = "Sales by Categories (Tree Map)",
       fill = "Category",
       caption = "Sales values are in USD") +
  theme_minimal() +
  theme(legend.position = "none",
        plot.title = element_text(size = 14, face = "bold"),
        plot.caption = element_text(size = 10, color = "gray"))

# Saving the image for the plot
this_filename_date <- as.character(Sys.Date())
this_filename_time <- as.character(format(Sys.time(), format = "%H_%M"))

ggsave(paste0("Visualisations/Treemap_for_sales_by_categories",
              this_filename_date,"_",
              this_filename_time,".png"))
```

# Query 8: Sales vs Ad Clicks Analysis

```{r}
# Query to retrieve total sales and ad clicks for each day

sales_ad_clicks_data <- dbGetQuery(my_db, "
  SELECT order_date,
  IFNULL(SUM(p.price * o.quantity * (1 - (o.discount / 100))), 0) AS total_sales,
  IFNULL(SUM(a.ad_clicks), 0) AS total_ad_clicks
  FROM orders AS o
  LEFT JOIN advertisements AS a ON o.product_id = a.product_id
  LEFT JOIN products AS p ON o.product_id = p.id
  GROUP BY order_date
")

# Convert order_date to Date format
sales_ad_clicks_data$order_date <- as.Date(sales_ad_clicks_data$order_date)

# Aggregate data by month
sales_ad_clicks_monthly <- sales_ad_clicks_data %>%
  mutate(order_month = floor_date(order_date, "month")) %>%
  group_by(order_month) %>%
  summarise(total_sales = sum(total_sales),
            total_ad_clicks = sum(total_ad_clicks))
            
# Apply log transformation to sales and ad clicks
sales_ad_clicks_monthly <- sales_ad_clicks_monthly %>%
  mutate(log_total_sales = log(total_sales + 1),  # Add 1 to avoid log(0)
         log_total_ad_clicks = log(total_ad_clicks + 1))  # Add 1 to avoid log(0)
            
sales_ad_clicks_monthly %>%
ggplot( aes(x = order_month)) +
  geom_line(aes(y = log_total_sales, color = "Total Sales"), size = 1.5) +
  geom_line(aes(y = log_total_ad_clicks, color = "Total Ad Clicks"), linetype = "dashed", size = 1.5) +
  scale_color_manual(values = c("Total Sales" = "#E41A1C", "Total Ad Clicks" = "#377EB8")) +  # Unique colors
  labs(title = "Trend of Sales and Ad Clicks Over Time",
       x = "Month",
       y = "Log Count") +
  theme_bw() +
  theme(legend.position = "top") +
  scale_x_date(date_labels = "%b %Y", date_breaks = "1 month") +
  ylim(0, max(c(max(sales_ad_clicks_monthly$log_total_sales), max(sales_ad_clicks_monthly$log_total_ad_clicks))))


# Saving the image for the plot
this_filename_date <- as.character(Sys.Date())
this_filename_time <- as.character(format(Sys.time(), format = "%H_%M"))

ggsave(paste0("Visualisations/sales_vs_ad_clicks_analysis",
              this_filename_date,"_",
              this_filename_time,".png"))


```


# Query 9: Top 5 Sellers Time Series Analysis

```{r}
xyz <- dbGetQuery(my_db, "SELECT order_date, seller_id,
  price * quantity * (1 - (discount / 100)) AS revenue
  FROM orders
  JOIN products ON orders.product_id = products.id"
)

top_5_sellers <- dbGetQuery(my_db,
                              "SELECT s.id AS seller_id,
                              s.name AS seller_name,
                              SUM(o.quantity) AS total_quantity_sold
                              FROM sellers AS s
                              INNER JOIN products AS p ON s.id = p.seller_id
                              INNER JOIN orders AS o ON p.id = o.product_id
                              GROUP BY s.id, s.name
                              ORDER BY total_quantity_sold DESC
                              LIMIT 5"
)


# Convert order_date to Date format
xyz$order_date <- as.Date(xyz$order_date, format = "%Y-%m-%d" )


# Aggregate by month
xyz <- xyz %>%
  mutate(year_month = floor_date(order_date, "month")) %>%
  group_by(seller_id, year_month) %>%
  filter(seller_id %in% top_5_sellers$seller_id)

ggplot(xyz, aes(x = factor(format(year_month, "%b %Y"), 
                                      levels = unique(format(year_month, "%b %Y"))), 
                          y = revenue, 
                          size = revenue)) +  # Set constant size for bubbles
  geom_point(aes(fill = seller_id), shape = 21, color = "black", alpha = 0.7) +  # Use fill aesthetic for seller names
  scale_size_continuous(range = c(5, 20)) +
  labs(title = "Top 5 Sellers Sales Over Time",
       x = "Order Month",
       y = "Total Sales",
       size = NULL,  # Remove legend for size aesthetic
       fill = "Seller Name") +  # Set legend title
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, margin = margin(t = 5, r = 5, b = 5, l = 5)),
        axis.title.x = element_blank(),
        plot.title = element_text(hjust = 0.5, size = 14, face = "bold"),  # Center and style title
        axis.text = element_text(size = 10),  # Adjust text size
        axis.title = element_text(size = 12, face = "bold"))  # Adjust title size and style

# Saving the image for the plot
this_filename_date <- as.character(Sys.Date())
this_filename_time <- as.character(format(Sys.time(), format = "%H_%M"))

ggsave(paste0("Visualisations/Top_5_sellers_time_series",
              this_filename_date,"_",
              this_filename_time,".png"))


```


# Query 10: Average Ratings of Products in each Category 

```{r}

rating_category <- dbGetQuery(my_db,
                              "SELECT categories.name AS category, AVG(orders.rating_review) AS avg_rating
                              FROM products
                              INNER JOIN orders ON products.id = orders.product_id
                              INNER JOIN categories ON products.category_id = categories.id
                              WHERE orders.rating_review IS NOT NULL
                              GROUP BY categories.name
                              ORDER BY avg_rating DESC"
)

rating_category$category <- factor(rating_category$category, levels = rating_category$category[order(rating_category$avg_rating, decreasing = FALSE)])

# Create a bar chart for analyzing average ratings by category
ggplot(rating_category, aes(x = category, y = avg_rating, fill = category)) +
  geom_bar(stat = "identity") +
  labs(title = "Average Ratings of Products by Category",
       x = "Category",
       y = "Average Rating") +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, size = 10, color = "#333333"), # Adjust text size and color
    axis.text.y = element_text(size = 10, color = "#333333"), # Adjust text size and color
    axis.title = element_text(size = 12, color = "#333333"), # Adjust axis title size and color
    plot.title = element_text(hjust = 0.5, size = 16, color = "#333333", face = "bold"), # Adjust title size and color, make it bold
    panel.background = element_rect(fill = "#f2f2f2"), # Change background color
    panel.grid.major = element_blank(), # Remove major gridlines
    panel.grid.minor = element_blank(), # Remove minor gridlines
    legend.position = "none" # Remove legend
  ) +
  geom_text(aes(label = round(avg_rating, 2)), vjust = -0.5, size = 3, fontface = "bold", color = "black") + # Add data labels with bold font and black color
  scale_fill_brewer(palette = "Set3") + # Apply a qualitative color palette
  coord_flip() # Flip the coordinates for better readability


# Saving the image for the plot
this_filename_date <- as.character(Sys.Date())
this_filename_time <- as.character(format(Sys.time(), format = "%H_%M"))

ggsave(paste0("Visualisations/average_ratings_of_products_in_each_category",
              this_filename_date,"_",
              this_filename_time,".png"))

```


# Query 11: Conversion Rate of Top 10 Products

```{r}
conversion_rate <- dbGetQuery(my_db,
"SELECT 
  o.product_id AS product_id,
  p.name AS product_name,
  SUM(o.quantity) AS total_quantity,
  SUM(a.ad_clicks) AS total_ad_clicks,
  SUM(o.quantity) / NULLIF(SUM(a.ad_clicks / 100000), 0) AS conversion_rate
FROM orders o
LEFT JOIN advertisements a ON o.product_id = a.product_id
LEFT JOIN products p ON o.product_id = p.id
GROUP BY o.product_id, p.name
ORDER BY conversion_rate DESC
LIMIT 10;"
)

# Converting the id column to factors 
conversion_rate$product_id <- factor(conversion_rate$product_id, levels = conversion_rate$product_id[order(-conversion_rate$conversion_rate)])

# Create a bar plot
ggplot(data = conversion_rate, aes(x = product_id, y = conversion_rate)) +
  geom_bar(stat = "identity", fill = "#5DA5DA", width = 0.6) +
  geom_text(aes(label = sprintf("%.2f", conversion_rate)), vjust = -0.5, size = 3, color = "black") +
  labs(x = "Product ID", y = "Conversion Rate", title = "Top 10 Products by Conversion Rate") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, vjust = 0.5, hjust = 1, size = 10, color = "#333333"), 
        axis.title = element_text(size = 12, face = "bold", color = "#333333"), 
        plot.title = element_text(size = 14, face = "bold", color = "#333333"),
        axis.text.y = element_text(size = 10, color = "#333333"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        plot.background = element_rect(fill = "white"),
        panel.background = element_rect(fill = "white"),
        legend.position = "none")

# Saving the image for the plot
this_filename_date <- as.character(Sys.Date())
this_filename_time <- as.character(format(Sys.time(), format = "%H_%M"))

ggsave(paste0("Visualisations/average_ratings_of_products_in_each_category",
              this_filename_date,"_",
              this_filename_time,".png"))



```



```{r}
# check the strcture of the dataset
str(product_data)
```

```{r}
summary(product_data)
```

```{r}
head(product_data)
```

```{r}
# Analysis on product price
ggplot(product_data, aes(x = price)) +
  geom_histogram(binwidth = 10, fill = "blue") +
  labs(title = "Product Price Distribution", x = "Price", y = "Frequency")
```


```{r}
# Analysis the product brand
brand_counts <- product_data %>%
  group_by(brand) %>%
  summarise(count = n()) %>%
  arrange(desc(count))

select_brand <- brand_counts[1:15, ]

ggplot(select_brand, aes(x = reorder(brand, -count), y = count)) +
  geom_bar(stat = "identity", fill = "blue") +
  coord_flip() +
  labs(title = "Product Brand Distribution", x = "Brand", y = "Count")
```

```{r}
# create a table to calculate the sales data
product_sales <- order_data %>%
  group_by(product_id) %>%
  summarise(total_quantity = sum(quantity)) %>%
  inner_join(product_data %>%
              group_by(product_id) %>%
              summarise(single_price = price), 
            by = "product_id")

product_sales$total_revenue <- product_sales$total_quantity * product_sales$single_price

# Sort by sales quantity and revenue, find the product with the highest sales quantity
best_selling_products_by_quantity <- product_sales %>%
  arrange(desc(total_quantity)) %>%
  head(10) 

best_selling_products_by_revenue <- product_sales %>%
  arrange(desc(total_revenue)) %>%
  head(10)  
```


```{r}
# highest sales quantity
ggplot(best_selling_products_by_quantity, aes(x = reorder(product_id, -total_quantity), y = total_quantity)) +
  geom_bar(stat = "identity", fill = "blue") +
  labs(title = "Top 10 Best-Selling Products by Quantity", x = "Product ID", y = "Total Quantity") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) 

# highest sales revenue
ggplot(best_selling_products_by_revenue, aes(x = reorder(product_id, -total_revenue), y = total_revenue)) +
  geom_bar(stat = "identity", fill = "blue") +
  labs(title = "Top 10 Best-Selling Products by Revenue", x = "Product ID", y = "Total Revenue") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))  

# Analysis on how price affect sales quantity
ggplot(product_sales, aes(x = single_price, y = total_quantity)) +
  geom_point(color = "blue") +
  labs(title = "Price vs. Sales Quantity",
       x = "Price",
       y = "Total Quantity Sold")

```


```{r}
# merge product_data and ads_data to get each product's ads clicks
product_ads <- left_join(product_data, advertisement_data, by = "product_id")

# calculate each product's total ads clicks
ads_clicks_data <- product_ads %>%
  group_by(product_id, name) %>%
  summarise(total_clicks = sum(ads_clicks, na.rm = TRUE))

ggplot(ads_clicks_data, aes(x = name, y = total_clicks)) +
  geom_bar(stat = "identity", fill = "blue") +
  labs(title = "Product vs. Ads Clicks", x = "Product Name", y = "Total Ads Clicks") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))  
```

```{r}
product_review <- left_join(product_data, order_data, by = "product_id")

# calculate each product's average rating
product_rating_data <- product_review %>%
  group_by(product_id, name) %>%
  summarise(avg_rating = mean(rating_review, na.rm = TRUE))

# plot relationship between product and rating
ggplot(product_rating_data, aes(x = name, y = avg_rating)) +
  geom_bar(stat = "identity", fill = "blue") +
  labs(title = "Product vs. Average Rating", x = "Product Name", y = "Average Rating") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) 
```


Close Connection
```{r disconnect}
# Disconnect from the database using the connection variable that we setup 
# before
RSQLite::dbDisconnect(my_db)

```





