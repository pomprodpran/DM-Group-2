---
title: "Report Group 2"
author: "Pom"
date: "2024-02-28"
output:
  pdf_document:
    toc: yes
    number_sections: yes
  word_document:
    toc: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,comment=NA,attr.source='.numberLines')

rm(list=ls())
library(readr)
library(RSQLite)
library(dplyr)
library(ggplot2)

```

# Task 1.2: SQL Database Schema Creation
```{r connect}
# set up the connection
my_db <- RSQLite::dbConnect(RSQLite::SQLite(),"../database/ecommerse.db")
```

## CREATE tables 
````{bash, eval=FALSE}
# link to SQL file
sqlite3 "../database/ecommerse.db" < "../main/ecommerse_v2.sql"
```

# Task 2.2: Import Data and validation
zx
## Validation
```{r}
all_files <- list.files("../data_upload/")

```

## Load files in an sqlite database
```{r}
for (variable in all_files) {
  this_filepath <- paste0("../data_upload/",variable)
  this_file_contents <- readr::read_csv(this_filepath)

  table_name <- gsub(".csv","",variable)
  #Remove prefix and suffix 
  #table_name <- gsub("olist_","",table_name)
  #table_name <- gsub("_dataset","",table_name)
  # table_name <- variable
  
  RSQLite::dbWriteTable(my_db,table_name,this_file_contents,append=TRUE)
}

```

Select Data

```{sql connection=my_db}
SELECT * 
FROM customers
```

# Data Analysis using SQL 

```{sql connection=my_db}
SELECT COUNT(*) AS total_categories
FROM categories;
```

```{sql connection=my_db}
-- Top 5 categories with the most products
SELECT c.category_name, COUNT(p.product_id) AS num_products
FROM categories c
LEFT JOIN products p ON c.category_id = p.category_id
GROUP BY c.category_id, c.category_name
ORDER BY num_products DESC
LIMIT 5;
```

```{sql connection=my_db}
-- Total Number of Orders for Each Customer
SELECT c.customer_id, c.customer_first_name, c.customer_last_name, COUNT(o.order_id) AS total_orders
FROM customers AS c
LEFT JOIN orders AS o ON c.customer_id = o.customer_id
GROUP BY c.customer_id, c.customer_first_name, c.customer_last_name;
```


```{sql connection=my_db}
-- Sellers with total revenue 
SELECT s.seller_id, s.seller_name, SUM(p.price) AS total_revenue
FROM sellers AS s
INNER JOIN products AS p ON s.seller_id = p.seller_id
INNER JOIN orders AS o ON p.product_id = o.product_id
GROUP BY s.seller_id, s.seller_name;
```


```{sql connection=my_db}
-- Top 10 best selling products based on quantity sold
SELECT p.product_id, p.name, p.color, p.size, SUM(o.quantity) AS total_quantity_sold
FROM products AS p
INNER JOIN orders AS o ON p.product_id = o.product_id
GROUP BY p.product_id, p.name, p.color, p.size
ORDER BY total_quantity_sold DESC
LIMIT 10;


```

```{sql connection=my_db}
-- Top 10 customers by the total amount spent

SELECT c.customer_id, c.customer_first_name, c.customer_last_name, SUM(p.price) AS total_spent
FROM customers AS c
INNER JOIN orders AS o ON c.customer_id = o.customer_id
INNER JOIN products AS p ON o.product_id = p.product_id
GROUP BY c.customer_id, c.customer_first_name, c.customer_last_name
ORDER BY total_spent DESC
LIMIT 10;

```

```{sql connection=my_db}
-- Average Order Value for Each Seller
SELECT s.seller_id, s.seller_name, AVG(p.price * o.quantity) AS average_order_value
FROM sellers AS s
INNER JOIN products AS p ON s.seller_id = p.seller_id
INNER JOIN orders AS o ON p.product_id = o.product_id
GROUP BY s.seller_id, s.seller_name;

```

```{sql connection=my_db}
-- Top 10 shippers with highest number of shippings
SELECT s.shipper_id, s.shipper_name, COUNT(*) AS total_orders_shipped
FROM shippers AS s
JOIN orders AS o ON s.shipper_id = o.shipper_id
GROUP BY s.shipper_id, s.shipper_name
ORDER BY total_orders_shipped DESC
LIMIT 10;

```

```{sql connection=my_db}
-- Average discount percentage applied to orders
SELECT AVG(discount) AS average_discount
FROM orders;
```


Close Connection
```{r disconnect}
# Disconnect from the database using the connection variable that we setup 
# before
RSQLite::dbDisconnect(my_db)

```

# Loading Data 
```{r}
customers <- read_csv("/cloud/project/data_upload/customers.csv", show_col_types = FALSE)
orders <- read_csv("/cloud/project/data_upload/orders.csv", show_col_types = FALSE)
sellers <- read_csv("/cloud/project/data_upload/sellers.csv", show_col_types = FALSE)
products <- read_csv("/cloud/project/data_upload/products.csv", show_col_types = FALSE)
categories <- read_csv("/cloud/project/data_upload/categories.csv", show_col_types = FALSE)
shippers <- read_csv("/cloud/project/data_upload/shippers.csv", show_col_types = FALSE)
advertisements <- read_csv("/cloud/project/data_upload/advertisements.csv", show_col_types = FALSE)
```


```{r}
# Top 10 Customers segmented by the Total Amount Spent
order_details <- orders %>%
  inner_join(products, by = "product_id") %>%
  inner_join(customers, by = "customer_id")

# Calculate total amount spent by each customer
customer_spending <- order_details %>%
  group_by(customer_id, customer_first_name, customer_last_name) %>%
  summarise(total_spent = sum(price * quantity), .groups = "drop") %>%
  arrange(desc(total_spent)) %>%
  top_n(10, total_spent)

# Plot top 10 customers with respect to amount spent
ggplot(customer_spending, aes(x = reorder(paste(customer_first_name, customer_last_name), -total_spent), y = total_spent)) +
  geom_bar(stat = "identity", fill = "salmon") +  # Change fill color to salmon
  labs(title = "Top 10 Customers by Amount Spent",
       x = "Customer",
       y = "Total Amount Spent") +
  coord_flip() +  # Flip the axis
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, color = "black")) 
```


```{r}
# Top 10 selling products
product_sales <- order_details %>%
  group_by(product_id, name) %>%
  summarise(total_quantity_sold = sum(quantity)) %>%
  arrange(desc(total_quantity_sold)) %>%
  top_n(10, total_quantity_sold)

top_10_products <- head(product_sales, 10)

ggplot(top_10_products, aes(x = reorder(name, total_quantity_sold), y = total_quantity_sold)) +
  geom_bar(stat = "identity", fill = "skyblue") +
  labs(title = "Top 10 Selling Products",
       x = "Product",
       y = "Total Quantity Sold") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

```


```{r}
# Top 10 shippers by the number of orders shipped
shipper_counts <- orders %>%
  group_by(shipper_id) %>%
  summarise(total_orders = n()) %>%
  arrange(desc(total_orders)) %>%
  slice(1:10)  

ggplot(shipper_counts, aes(x = reorder(shipper_id, total_orders), y = total_orders)) +
  geom_bar(stat = "identity", fill = "grey") +
  labs(title = "Orders by Shipper",
       x = "Shipper ID",
       y = "Total Orders") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))


```











